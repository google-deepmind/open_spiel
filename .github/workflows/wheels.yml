# Builds and tests the OpenSpiel wheels using cibuildwheel.
#
# Each wheel is built via the manylinux2014 pypa Docker image on Linux,
# standard MacOS X, and Windows using MSVC. Each binary wheel is built for
# x86_64 (and arm64 where supported). Basic API tests are run within the build
# environment. Full tests (tests that use extra dependencies such as PyTorch,
# JAX, Tensorflow) are tested in the Github Actions CI environment.
name: wheels

on:
  # Test the wheels for each PR to ensure the PR doesn't break them.
  pull_request:
    branches: [ master ]
  # Workflow dispatch is a way to manually trigger workflows. This will be
  # used to build and test the wheels manually for releases.
  workflow_dispatch:
    inputs:
      name:
        description: 'Workflow dispatch (triggered manually)'
        required: false
        default: 'No name specified'

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }} ${{ matrix.NAME }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
        - os: ubuntu-24.04
          NAME: "Linux"
          OS_TYPE: "Linux"
          CI_PYBIN: python3.12
          OS_PYTHON_VERSION: 3.12
          OPEN_SPIEL_ABSL_VERSION: "20250814.1"
          CIBW_VERSION: 3.2.1
          CIBW_ENABLE: all
          CIBW_ENVIRONMENT: "CXX=$(which g++) OPEN_SPIEL_BUILDING_WHEEL='ON' OPEN_SPIEL_BUILD_WITH_ACPC='ON' OPEN_SPIEL_BUILD_WITH_HANABI='ON' OPEN_SPIEL_BUILD_WITH_ROSHAMBO='ON'"
          CIBW_BUILD: cp311-manylinux_x86_64 cp312-manylinux_x86_64 cp313-manylinux_x86_64 cp314-manylinux_x86_64
        # Temporarily disabled due to scipy compatibility issues
        # - os: ubuntu-24.04-arm
        #   NAME: "Linux_arm64"
        #   OS_TYPE: "Linux"
        #   CI_PYBIN: python3.12
        #   OS_PYTHON_VERSION: 3.12
        #   OPEN_SPIEL_ABSL_VERSION: "20250814.1"
        #   CIBW_VERSION: 3.2.1
        #   CIBW_ENABLE: all
        #   CIBW_ENVIRONMENT: "CXX=$(which g++) OPEN_SPIEL_BUILDING_WHEEL='ON' OPEN_SPIEL_BUILD_WITH_ACPC='ON' OPEN_SPIEL_BUILD_WITH_HANABI='ON' OPEN_SPIEL_BUILD_WITH_ROSHAMBO='ON'"
        #   CIBW_BUILD: cp311-manylinux_aarch64 cp312-manylinux_aarch64 cp313-manylinux_aarch64 cp314-manylinux_aarch64
        - os: macos-14
          OS_TYPE: "Darwin"
          CI_PYBIN: python3.12
          OS_PYTHON_VERSION: 3.12
          CIBW_VERSION: 3.2.1
          CIBW_ENABLE: all
          CIBW_ENVIRONMENT: "OPEN_SPIEL_BUILDING_WHEEL='ON' OPEN_SPIEL_BUILD_WITH_ACPC='ON' OPEN_SPIEL_BUILD_WITH_HANABI='ON' OPEN_SPIEL_BUILD_WITH_ROSHAMBO='ON'"
          CIBW_BUILD: cp311-macosx_arm64 cp312-macosx_arm64 cp313-macosx_arm64
        - os: macos-15
          NAME: "MacOS15_Python_3.13"
          OS_TYPE: "Darwin"
          CI_PYBIN: python3.13
          OPEN_SPIEL_ABSL_VERSION: "20250814.1"
          OS_PYTHON_VERSION: 3.13
          CIBW_VERSION: 3.2.1
          CIBW_ENVIRONMENT: "OPEN_SPIEL_BUILDING_WHEEL='ON' OPEN_SPIEL_BUILD_WITH_ACPC='ON' OPEN_SPIEL_BUILD_WITH_HANABI='ON' OPEN_SPIEL_BUILD_WITH_ROSHAMBO='ON'"
          CIBW_BUILD: cp314-macosx_arm64
    env:
      OPEN_SPIEL_BUILDING_WHEEL: ON
      OPEN_SPIEL_BUILD_WITH_ACPC: ON
      OPEN_SPIEL_BUILD_WITH_HANABI: ON
      OPEN_SPIEL_BUILD_WITH_ROSHAMBO: ON
      OPEN_SPIEL_ABSL_VERSION: ${{ matrix.OPEN_SPIEL_ABSL_VERSION }}
      OS_TYPE: ${{ matrix.OS_TYPE }}
      OS_PYTHON_VERSION: ${{ matrix.OS_PYTHON_VERSION }}
      CI_PYBIN: ${{ matrix.CI_PYBIN }}
      CIBW_VERSION: ${{ matrix.CIBW_VERSION }}
      CIBW_ENABLE: ${{ matrix.CIBW_ENABLE }}
      CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
      CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
      CIBW_BUILD: ${{ matrix.CIBW_BUILD }}
      CIBW_BEFORE_TEST: python -m pip install --upgrade pip
      CIBW_TEST_COMMAND: /bin/bash {project}/open_spiel/scripts/test_wheel.sh basic {project}
      CIBW_ENVIRONMENT: ${{ matrix.CIBW_ENVIRONMENT }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6

      - name: Install
        run: |
          pwd
          uname -a
          ./open_spiel/scripts/ci_python_prechecks.sh
          [[ "${OS_TYPE}" = "Darwin" ]] && brew install python@${OS_PYTHON_VERSION}
          [[ "${OS_TYPE}" = "Darwin" ]] && brew link --force python@${OS_PYTHON_VERSION}
          which g++
          g++ --version
          chmod +x install.sh
          # This is needed to grab OpenSpiel dependencies.
          [[ "${OS_TYPE}" = "Darwin" ]] && ./install.sh `which python${OS_PYTHON_VERSION}`
          [[ "${OS_TYPE}" = "Linux" ]] && ./install.sh `which python3`
          # These are necessary to install what is necessary for the build and for the full tests below.
          ${CI_PYBIN} -m venv ./venv
          source ./venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip --version
          [[ "${OS_TYPE}" = "Darwin" ]] && python -m pip install pipx
          python -m pip install --upgrade setuptools
          python -m pip install --upgrade -r requirements.txt -q
          source ./open_spiel/scripts/python_extra_deps.sh python
          python -m pip install --no-cache-dir --upgrade $OPEN_SPIEL_PYTHON_JAX_DEPS
          python -m pip install --no-cache-dir --upgrade $OPEN_SPIEL_PYTHON_PYTORCH_DEPS --index-url https://download.pytorch.org/whl/cpu --extra-index-url https://pypi.org/simple
          python -m pip install --no-cache-dir --upgrade $OPEN_SPIEL_PYTHON_MISC_DEPS
          python -m pip install twine
          python -m pip install cibuildwheel==${CIBW_VERSION}
      - name: Build sdist
        run: |
          source ./venv/bin/activate
          pipx run build --sdist
          twine check dist/*.tar.gz

      # Build all the wheels and run the basic tests (within the docker images)
      # Basic tests are run via the CIBW_TEST_COMMAND environment variable.
      - name: Build bdist_wheel and run tests
        run: |
          [[ "${OS_TYPE}" = "Darwin" ]] && xcodebuild -version
          source ./venv/bin/activate
          python -m cibuildwheel --output-dir wheelhouse
          ls -l wheelhouse

      # Install the built wheel and run the full tests on this host. The full
      # tests include all the ones that use the machine learning libraries,
      # such as Tensorflow, PyTorch, and JAX.
      - name: Install bdist_wheel and full tests
        run: |
          source ./venv/bin/activate
          ./open_spiel/scripts/test_wheel.sh full `pwd` python

      - uses: actions/upload-artifact@v6
        with:
          name: artifact-${{ matrix.os }}-${{ matrix.NAME }}
          path: |
            dist/*.tar.gz
            ./wheelhouse/*.whl

  # Windows wheel builds - separate job due to different build process (no cibuildwheel)
  build_windows_wheels:
    name: Build wheels on Windows Python ${{ matrix.python-version }}
    runs-on: windows-latest
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']

    env:
      OPEN_SPIEL_BUILDING_WHEEL: ON

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install CMake
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          refreshenv
        shell: pwsh

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install build wheel setuptools
        shell: pwsh

      - name: Clone dependencies
        run: |
          git clone --single-branch --depth 1 https://github.com/pybind/pybind11.git pybind11
          git clone -b 20250814.1 --single-branch --depth 1 https://github.com/abseil/abseil-cpp.git open_spiel/abseil-cpp
          git clone -b master https://github.com/nlohmann/json.git open_spiel/json
          cd open_spiel/json && git checkout 9cca280a4d0ccf0c08f47a99aa71d1b0e52f8d03 && cd ../..
          git clone -b master https://github.com/pybind/pybind11_json.git open_spiel/pybind11_json
          cd open_spiel/pybind11_json && git checkout d0bf434be9d287d73a963ff28745542daf02c08f && cd ../..
          git clone -b master https://github.com/pybind/pybind11_abseil.git open_spiel/pybind11_abseil
          cd open_spiel/pybind11_abseil && git checkout 73992b5 && cd ../..
          git clone -b develop --single-branch --depth 1 https://github.com/jblespiau/dds.git open_spiel/games/bridge/double_dummy_solver
        shell: pwsh

      - name: Build wheel
        run: |
          python -m build --wheel --outdir dist/
          if (!(Test-Path dist/*.whl)) { Write-Error "No wheel file generated"; exit 1 }
          Get-ChildItem dist/*.whl
        shell: pwsh

      - name: Test wheel installation
        run: |
          $wheel = Get-ChildItem dist/*.whl | Select-Object -First 1
          python -m pip install $wheel.FullName
          python -c "import pyspiel; game = pyspiel.load_game('tic_tac_toe'); print('OpenSpiel works! Game:', game.get_type().short_name)"
        shell: pwsh

      - name: Run basic tests
        run: |
          python -c "import pyspiel; print('Registered games:', len(pyspiel.registered_names()))"
          python -c "import pyspiel; g = pyspiel.load_game('kuhn_poker'); print('Kuhn poker loaded successfully')"
          python -c "import pyspiel; g = pyspiel.load_game('leduc_poker'); print('Leduc poker loaded successfully')"
        shell: pwsh

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wheels-windows-py${{ matrix.python-version }}
          path: dist/*.whl
